<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Syncthing K8s Setup on Ubuntu 20.04 | Questionable Engineering</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ComputingKubernetesMicrok8s" />
  
  
  
  
  <meta name="description" content="Install the k8s cluster if not already installed12microk8s enable dns storage helm3microk8s status  Pull the syncthing helm chart123microk8s helm repo add truecharts https:&#x2F;&#x2F;charts.truechart">
<meta property="og:type" content="article">
<meta property="og:title" content="Syncthing K8s Setup on Ubuntu 20.04">
<meta property="og:url" content="http://questionableengineering.com/2023/05/24/Syncthing-K8s-Setup-on-Ubuntu-20-04/index.html">
<meta property="og:site_name" content="Questionable Engineering">
<meta property="og:description" content="Install the k8s cluster if not already installed12microk8s enable dns storage helm3microk8s status  Pull the syncthing helm chart123microk8s helm repo add truecharts https:&#x2F;&#x2F;charts.truechart">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-25T02:44:44.000Z">
<meta property="article:modified_time" content="2025-06-03T01:35:18.157Z">
<meta property="article:author" content="John Grun">
<meta property="article:tag" content="Computing">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Microk8s">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Questionable Engineering" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/fashion.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

<meta name="generator" content="Hexo 5.4.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src="">
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src="">
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg,https://source.unsplash.com/collection/954550/1920x1080,https://source.unsplash.com/collection/954550/1920x1081".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" 
   style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);"  >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="Questionable Engineering" rel="home"> Questionable Engineering </a>
            
          </h1>
          
          
            <div class="site-description">A collection of pointless, random, and probably bad ideas</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Syncthing-K8s-Setup-on-Ubuntu-20-04" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Syncthing K8s Setup on Ubuntu 20.04
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2023/05/24/Syncthing-K8s-Setup-on-Ubuntu-20-04/" class="article-date">
	  <time datetime="2023-05-25T02:44:44.000Z" itemprop="datePublished">May 24, 2023</time>
	</a>

       
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Install-the-k8s-cluster-if-not-already-installed"><a href="#Install-the-k8s-cluster-if-not-already-installed" class="headerlink" title="Install the k8s cluster if not already installed"></a>Install the k8s cluster if not already installed</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">microk8s enable dns storage helm3</span><br><span class="line">microk8s status</span><br></pre></td></tr></table></figure>

<h1 id="Pull-the-syncthing-helm-chart"><a href="#Pull-the-syncthing-helm-chart" class="headerlink" title="Pull the syncthing helm chart"></a>Pull the syncthing helm chart</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">microk8s helm repo add truecharts https:&#x2F;&#x2F;charts.truecharts.org&#x2F;</span><br><span class="line">microk8s helm repo update</span><br><span class="line">microk8s helm pull truecharts&#x2F;syncthing --version 15.0.1</span><br></pre></td></tr></table></figure>

<h1 id="Modify-the-values-yaml-file-to-set-the-configuration"><a href="#Modify-the-values-yaml-file-to-set-the-configuration" class="headerlink" title="Modify the values.yaml file to set the configuration"></a>Modify the values.yaml file to set the configuration</h1><p>Weâ€™re going to set the syncthing configuration within the container.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf .&#x2F;syncthing-15.0.1.tgz</span><br><span class="line">cd syncting</span><br><span class="line">cat values.yamls</span><br></pre></td></tr></table></figure>

<h2 id="Make-the-data-directory"><a href="#Make-the-data-directory" class="headerlink" title="Make the data directory"></a>Make the data directory</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;path&#x2F;to&#x2F;</span><br><span class="line">chown -R 777 &#x2F;path&#x2F;to&#x2F;</span><br><span class="line"></span><br><span class="line">mkdir &#x2F;path&#x2F;to&#x2F;data</span><br><span class="line">chown -R 777 &#x2F;path&#x2F;to&#x2F;&#x2F;data</span><br></pre></td></tr></table></figure>
<h1 id="Create-Persistent-Volumes-and-Persistent-Volume-Claims"><a href="#Create-Persistent-Volumes-and-Persistent-Volume-Claims" class="headerlink" title="Create Persistent Volumes and Persistent Volume Claims"></a>Create Persistent Volumes and Persistent Volume Claims</h1><p>If the Syncthing configuration files are on a different disk than your files and the harddisk containing your files fails to mount, Syncthing can think you deleted all your files. Syncthing will then tell the other nodes to delete all files in that directory. To prevent this issue, we will store the configuration along with the files. If the harddisk does not mount the entire node will disappear and will not corrupt any other Syncthing nodes. </p>
<h2 id="Persistent-Volumes"><a href="#Persistent-Volumes" class="headerlink" title="Persistent Volumes"></a>Persistent Volumes</h2><h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><p>syncthing-server-config-pv.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: syncthing-server-config-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 100Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  local:</span><br><span class="line">    path: &#x2F;path&#x2F;to&#x2F; # This must exist on the host. This is the path above the data directory </span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io&#x2F;hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - Hostname</span><br></pre></td></tr></table></figure>

<p>microk8s kubectl apply -f syncthing-server-config-pv.yaml</p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>syncthing-server-data-pv.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: syncthing-server-data-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3Ti</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  local:</span><br><span class="line">    path: &#x2F;path&#x2F;to&#x2F;data # This must exist on the host</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io&#x2F;hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - Hostname</span><br></pre></td></tr></table></figure>

<p>microk8s kubectl apply -f syncthing-server-data-pv.yaml</p>
<p>microk8s kubectl get pv </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                               STORAGECLASS   REASON   AGE                             </span><br><span class="line">syncthing-server-data-pv  3Ti   RWO           Retain           Bound    default&#x2F;syncthing-server-data-pvc   local-storage   4h41m</span><br><span class="line">syncthing-server-config-pv100Gi RWO           Retain           Bound    default&#x2F;syncthing-server-config-pvc local-storage   4h38m</span><br></pre></td></tr></table></figure>

<h2 id="Persistent-Volume-Claims"><a href="#Persistent-Volume-Claims" class="headerlink" title="Persistent Volume Claims"></a>Persistent Volume Claims</h2><h3 id="Config-1"><a href="#Config-1" class="headerlink" title="Config"></a>Config</h3><p>syncthing-server-config-pvc.yaml<br>Bonds to syncthing-server-config-pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: syncthing-server-config-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: local-storage # Empty string must be explicitly set otherwise default StorageClass will be set</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  volumeName: syncthing-server-config-pv</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 100Gi</span><br></pre></td></tr></table></figure>

<p>microk8s kubectl apply -f syncthing-server-config-pvc.yaml</p>
<h3 id="Data-1"><a href="#Data-1" class="headerlink" title="Data"></a>Data</h3><p>syncthing-server-data-pvc.yaml<br>Bonds to syncthing-server-data-pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: syncthing-server-data-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: local-storage # Empty string must be explicitly set otherwise default StorageClass will be set</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  volumeName: syncthing-server-data-pv</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Ti</span><br></pre></td></tr></table></figure>

<p>microk8s kubectl apply -f syncthing-server-data-pvc.yaml</p>
<p>microk8s kubectl get pvc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS        AGE</span><br><span class="line">syncthing-server-data-pvc     Bound    syncthing-server-data-pv                   3Ti        RWO            local-storage       4h39m</span><br><span class="line">syncthing-server-config-pvc   Bound    syncthing-server-config-pv                 100Gi      RWO            local-storage       4h34m</span><br></pre></td></tr></table></figure>

<h1 id="Update-the-values-file"><a href="#Update-the-values-file" class="headerlink" title="Update the values file"></a>Update the values file</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano values.yamls</span><br></pre></td></tr></table></figure>
<p>Update the persistence section as follows</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">image:</span><br><span class="line">  repository: tccr.io&#x2F;truecharts&#x2F;syncthing</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  tag: v1.23.7@sha256:f2dd1847b81302b4f07e0b50019d958b1b77e7fd5de689972eaa0fd9f0d27d41</span><br><span class="line"></span><br><span class="line">workload:</span><br><span class="line">  main:</span><br><span class="line">    podSpec:</span><br><span class="line">      containers:</span><br><span class="line">        main:</span><br><span class="line">          probes:</span><br><span class="line">            liveness:</span><br><span class="line">              path: &#x2F;rest&#x2F;noauth&#x2F;health</span><br><span class="line">            readiness:</span><br><span class="line">              path: &#x2F;rest&#x2F;noauth&#x2F;health</span><br><span class="line">            startup:</span><br><span class="line">              path: &#x2F;rest&#x2F;noauth&#x2F;health</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  main:</span><br><span class="line">    ports:</span><br><span class="line">      main:</span><br><span class="line">        port: PORTA</span><br><span class="line">        targetPort: PORTA</span><br><span class="line">        type: NodePort</span><br><span class="line">  listeners:</span><br><span class="line">    enabled: true</span><br><span class="line">    ports:</span><br><span class="line">      tcp:</span><br><span class="line">        enabled: true</span><br><span class="line">        port: PORTB</span><br><span class="line">        targetPort: PORTB</span><br><span class="line">        type: NodePort</span><br><span class="line">  listeners-udp:</span><br><span class="line">    enabled: true</span><br><span class="line">    ports:</span><br><span class="line">      udp:</span><br><span class="line">        enabled: true</span><br><span class="line">        port: PORTB</span><br><span class="line">        targetPort: PORTB</span><br><span class="line">        protocol: udp</span><br><span class="line">        type: NodePort</span><br><span class="line">  discovery:</span><br><span class="line">    enabled: true</span><br><span class="line">    ports:</span><br><span class="line">      discovery:</span><br><span class="line">        enabled: true</span><br><span class="line">        port: PORTC</span><br><span class="line">        targetPort: PORTC</span><br><span class="line">        protocol: udp</span><br><span class="line">        type: NodePort</span><br><span class="line"></span><br><span class="line">persistence:</span><br><span class="line">  config:</span><br><span class="line">    enabled: true</span><br><span class="line">    mountPath: &quot;&#x2F;var&#x2F;syncthing&quot;</span><br><span class="line">    type: pvc</span><br><span class="line">    existingClaim: syncthing-server-config-pvc</span><br><span class="line">  data:</span><br><span class="line">    enabled: true</span><br><span class="line">    mountPath: &quot;&#x2F;var&#x2F;syncthing&#x2F;data&quot;</span><br><span class="line">    type: pvc</span><br><span class="line">    existingClaim: syncthing-server-data-pvc</span><br><span class="line"></span><br><span class="line">portal:</span><br><span class="line">  open:</span><br><span class="line">    enabled: true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Install-the-helm-chart-with-our-values-yaml-file"><a href="#Install-the-helm-chart-with-our-values-yaml-file" class="headerlink" title="Install the helm chart with our values.yaml file"></a>Install the helm chart with our values.yaml file</h2><p>microk8s helm install syncthing-server truecharts/syncthing â€“values ./values.yaml </p>
<h2 id="Check-the-status-of-the-installed-application"><a href="#Check-the-status-of-the-installed-application" class="headerlink" title="Check the status of the installed application."></a>Check the status of the installed application.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">microk8s status</span><br><span class="line">microk8s kubectl describe pods</span><br><span class="line">microk8s kubectl</span><br><span class="line">microk8s kubectl logs</span><br><span class="line">microk8s kubectl describe pods</span><br></pre></td></tr></table></figure>

<h1 id="Common-Errors"><a href="#Common-Errors" class="headerlink" title="Common Errors"></a>Common Errors</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error from server (BadRequest): container in pod is waiting to start: ContainerCreating</span><br></pre></td></tr></table></figure>
<p>You probably need to change the permissions on the PV directory. This path is what is written in the PersistentVolume variable. A quick chmod -R 777 to this path will most likely fix the issue. The conatiner should update the permissions once it runs for the first time.  </p>
<h1 id="Service-yaml-file"><a href="#Service-yaml-file" class="headerlink" title="Service yaml file"></a>Service yaml file</h1><p>We need to expose the service to the outside world.<br>Thankfully microk8s has a built in loadbalancer called metallb</p>
<p>PORTA TCP â€“ Webserver/HTTP<br>PORTB TCP/UDP â€“ TCP - TCP based sync protocol traffic, UDP - QUIC based sync protocol traffic<br>PORTC UDP â€“ for discovery broadcasts on IPv4 and multicasts on IPv6</p>
<p>syncthing-server-service.yaml  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: syncthing-server-service</span><br><span class="line">spec:</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io&#x2F;name: syncthing</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: PORTA</span><br><span class="line">      targetPort: PORTA</span><br><span class="line">    - name: sync-tcp</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: PORTB</span><br><span class="line">      targetPort: PORTB</span><br><span class="line">    - name: sync-udp</span><br><span class="line">      protocol: UDP</span><br><span class="line">      port: PORTB</span><br><span class="line">      targetPort: PORTB</span><br><span class="line">    - name: discovery</span><br><span class="line">      protocol: UDP</span><br><span class="line">      port: PORTC</span><br><span class="line">      targetPort: PORTC</span><br><span class="line">  externalIPs:</span><br><span class="line">    - A.B.C.D</span><br></pre></td></tr></table></figure>
<p>More information here<br><a target="_blank" rel="noopener" href="https://medium.com/swlh/kubernetes-external-ip-service-type-5e5e9ad62fcd">https://medium.com/swlh/kubernetes-external-ip-service-type-5e5e9ad62fcd</a></p>
<h1 id="Apply-the-service"><a href="#Apply-the-service" class="headerlink" title="Apply the service"></a>Apply the service</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">microk8s kubectl apply -f .&#x2F;syncthing-server-service.yaml </span><br></pre></td></tr></table></figure>
<h2 id="Confirm-the-service-is-active"><a href="#Confirm-the-service-is-active" class="headerlink" title="Confirm the service is active"></a>Confirm the service is active</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">microk8s kubectl describe services syncthing-server-service</span><br></pre></td></tr></table></figure>

<h1 id="Firewall-Rules"><a href="#Firewall-Rules" class="headerlink" title="Firewall Rules"></a>Firewall Rules</h1><p>This assumes you are using ufw.<br>ufw is bascally a wrapper for IPTABLES. If you have ever used IPTABLES before you understand why ufw exists.<br><a target="_blank" rel="noopener" href="https://docs.syncthing.net/users/firewall.html">https://docs.syncthing.net/users/firewall.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo ufw default allow routed </span><br><span class="line"></span><br><span class="line">sudo ufw allow from A.B.C.D&#x2F;24 to any port PORTA proto tcp</span><br><span class="line">sudo ufw allow from 0.0.0.0&#x2F;24 to any port PORTB proto tcp</span><br><span class="line">sudo ufw allow from 0.0.0.0&#x2F;24 to any port PORTB proto udp</span><br><span class="line">sudo ufw allow from 0.0.0.0&#x2F;24 to any port PORTC proto udp</span><br><span class="line"></span><br><span class="line">sudo ufw status</span><br></pre></td></tr></table></figure>
<h1 id="External-GUI-Access"><a href="#External-GUI-Access" class="headerlink" title="External GUI Access"></a>External GUI Access</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo nano PATH-FROM-syncthing-server-config-pv-FILE&#x2F;config.xml</span><br><span class="line">    &lt;gui enabled&#x3D;&quot;true&quot; tls&#x3D;&quot;true&quot; debugging&#x3D;&quot;false&quot;&gt;</span><br><span class="line">        &lt;address&gt;A.B.C.0:PORTA&lt;&#x2F;address&gt;</span><br><span class="line">        &lt;apikey&gt;RANDOMSTRING&lt;&#x2F;apikey&gt;</span><br><span class="line">        &lt;theme&gt;default&lt;&#x2F;theme&gt;</span><br><span class="line">    &lt;&#x2F;gui&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Restart-Syncthing-to-pickup-gui-changes"><a href="#Restart-Syncthing-to-pickup-gui-changes" class="headerlink" title="Restart Syncthing to pickup gui changes"></a>Restart Syncthing to pickup gui changes</h2><p>microk8s kubectl get pods</p>
<p>microk8s kubectl exec syncthing-server-RANDOMHASH â€“ ps -A</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 568       0:00 &#x2F;bin&#x2F;syncthing</span><br><span class="line">   16 568       0:08 &#x2F;bin&#x2F;syncthing</span><br><span class="line">   33 568       0:00 ps -A</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>We want to kill the syncthing process. This will cause the container to restart and make syncthing load our config changes. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">microk8s kubectl exec syncthing-server-RANDOMHASH kill-9  16</span><br></pre></td></tr></table></figure>

<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">https://kubernetes.io/docs/concepts/services-networking/service/</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computing/" rel="tag">Computing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microk8s/" rel="tag">Microk8s</a></li></ul>

      
        
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'questionableengineering.disqus.com';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>



      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/08/23/Transmission-Kubernetes-Setup-on-Ubuntu/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Transmission Kubernetes Setup on Ubuntu
        
      </div>
    </a>
  
  
    <a href="/2023/04/16/MQTT-K8s-Setup-on-Ubuntu-20-04/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">MQTT K8s Setup on Ubuntu 20.04</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Install-the-k8s-cluster-if-not-already-installed"><span class="nav-number">1.</span> <span class="nav-text">Install the k8s cluster if not already installed</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pull-the-syncthing-helm-chart"><span class="nav-number">2.</span> <span class="nav-text">Pull the syncthing helm chart</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Modify-the-values-yaml-file-to-set-the-configuration"><span class="nav-number">3.</span> <span class="nav-text">Modify the values.yaml file to set the configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Make-the-data-directory"><span class="nav-number">3.1.</span> <span class="nav-text">Make the data directory</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create-Persistent-Volumes-and-Persistent-Volume-Claims"><span class="nav-number">4.</span> <span class="nav-text">Create Persistent Volumes and Persistent Volume Claims</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Persistent-Volumes"><span class="nav-number">4.1.</span> <span class="nav-text">Persistent Volumes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Config"><span class="nav-number">4.1.1.</span> <span class="nav-text">Config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data"><span class="nav-number">4.1.2.</span> <span class="nav-text">Data</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Persistent-Volume-Claims"><span class="nav-number">4.2.</span> <span class="nav-text">Persistent Volume Claims</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Config-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">Config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">Data</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Update-the-values-file"><span class="nav-number">5.</span> <span class="nav-text">Update the values file</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-the-helm-chart-with-our-values-yaml-file"><span class="nav-number">5.1.</span> <span class="nav-text">Install the helm chart with our values.yaml file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Check-the-status-of-the-installed-application"><span class="nav-number">5.2.</span> <span class="nav-text">Check the status of the installed application.</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Common-Errors"><span class="nav-number">6.</span> <span class="nav-text">Common Errors</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Service-yaml-file"><span class="nav-number">7.</span> <span class="nav-text">Service yaml file</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Apply-the-service"><span class="nav-number">8.</span> <span class="nav-text">Apply the service</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Confirm-the-service-is-active"><span class="nav-number">8.1.</span> <span class="nav-text">Confirm the service is active</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Firewall-Rules"><span class="nav-number">9.</span> <span class="nav-text">Firewall Rules</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#External-GUI-Access"><span class="nav-number">10.</span> <span class="nav-text">External GUI Access</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Restart-Syncthing-to-pickup-gui-changes"><span class="nav-number">10.1.</span> <span class="nav-text">Restart Syncthing to pickup gui changes</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">11.</span> <span class="nav-text">References</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2025 Questionable Engineering All Rights Reserved.
        
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/bootstrap.js"></script>


<script src="/js/main.js"></script>








  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
